name: Build Qemu Source

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Clone repository
        uses: actions/checkout@v2

      - name: Download qemu source
        shell: bash {0}
        run: |
          sudo bash
          wget https://download.qemu.org/qemu-7.1.0-rc1.tar.xz
          tar -xvf qemu-7.1.0-rc1.tar.xz
          cd qemu-7.1.0-rc1.tar.xz

      - name: Build deps
        run: |
           apt -y install g++ 
           apt install libvirglrenderer-dev -y && apt install mesa-common-dev -y && apt install libspice-client-gtk-3.0-dev -y && apt install libepoxy-dev -y && apt install libgbm-dev -y && apt install libdrm-dev -y && apt install libsdl2-2.0-0 -y && apt install python3-sdl2 -y && apt install libpng-dev -y && apt install libjpeg-dev -y && apt install libssl-dev -y && apt install libspice-protocol-dev -y && apt install libspice-server-dev -y && apt install libfdt-dev -y && apt install libsdl2-dev -y && apt install libusb-dev -y && apt install libusb-1.0-0-dev -y && apt install build-essential -y && apt install libusbredirhost-dev -y && apt install libseccomp-dev -y && apt install libcap-ng-dev -y && apt install libaio-dev -y && apt install xz-utils -y && apt install wget -y && sudo apt-get install git libglib2.0-dev libfdt-dev libpixman-1-dev zlib1g-dev ninja-build -y && sudo apt-get install git-email -y
           sudo apt-get install libaio-dev libbluetooth-dev libcapstone-dev libbrlapi-dev libbz2-dev -y
           sudo apt-get install libcap-ng-dev libcurl4-gnutls-dev libgtk-3-dev -y
           sudo apt-get install libibverbs-dev libjpeg8-dev libncurses5-dev libnuma-dev -y
           sudo apt-get install librbd-dev librdmacm-dev -y
           sudo apt-get install libsasl2-dev libsdl2-dev libseccomp-dev libsnappy-dev libssh-dev -y
           sudo apt-get install libvde-dev libvdeplug-dev libvte-2.91-dev libxen-dev liblzo2-dev -y
           sudo apt-get install valgrind xfslibs-dev -y
           sudo apt-get install libnfs-dev libiscsi-dev -y
           pkg-config libjpeg-dev libssl-dev libspice-protocol-dev libspice-server-dev
       
      - name: Build source
        run: |
          mkdir b
          cd b
          mkdir ~/seccond_prefix
          ../configure --prefix=~/seccond_prefix --target-list=i386-softmmu,x86_64-softmmu,arm-softmmu,aarch64-softmmu --enable-guest-agent --enable-vnc --enable-vnc-jpeg --enable-vnc-png --enable-kvm --enable-spice --enable-sdl --enable-virglrenderer --enable-opengl --enable-libusb --enable-usb-redir --enable-gtk --enable-modules --enable-debug --enable-debug-tcg --enable-sanitizers --enable-plugins
          make -j6
          sudo make install

      - name: Upload
        uses: actions/upload-artifact@v2
        with:
          name: qemu_source
          path: ~/seccond_prefix
